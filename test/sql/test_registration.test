# name: test/sql/test_registration.test
# description: Test worker and driver node registration functions for distributed execution
# group: [sql]

require duckherder

# Start standalone workers.
statement ok
SELECT duckherder_start_standalone_worker(29101);

# Start distributed server without workers.
statement ok
SELECT duckherder_start_local_server(8815);

query I
SELECT duckherder_get_worker_count();
----
0

# Register the standalone workers.
statement ok
SELECT duckherder_register_worker('worker_ext_1', 'grpc://localhost:29101');

query I
SELECT duckherder_get_worker_count();
----
1

# Start additional local workers after driver starts and register.  
statement ok
SELECT duckherder_start_standalone_worker(29102);

statement ok
SELECT duckherder_register_worker('worker_ext_2', 'grpc://localhost:29102');

query I
SELECT duckherder_get_worker_count();
----
2

statement ok
ATTACH DATABASE 'dh' (TYPE duckherder, server_host 'localhost', server_port 8815);

statement ok
USE dh;

# Execute queries and validate.
query I
SELECT main.duckherder_get_worker_count();
----
2

statement ok
PRAGMA duckherder_register_remote_table('worker_reg_test', 'worker_reg_test');

statement ok
CREATE TABLE worker_reg_test (id INTEGER, name VARCHAR);

statement ok
INSERT INTO worker_reg_test VALUES (1, 'test1'), (2, 'test2'), (3, 'test3');

query II
SELECT * FROM worker_reg_test ORDER BY id;
----
1	test1
2	test2
3	test3

# Test driver node registration.
statement ok
SELECT main.duckherder_register_or_replace_driver('driver-1', 'grpc://localhost:8815');

# Replace the driver node with a different one.
statement ok
SELECT main.duckherder_register_or_replace_driver('driver-2', 'grpc://localhost:8815');

# The function should work multiple times (idempotent).
statement ok
SELECT main.duckherder_register_or_replace_driver('driver-3', 'grpc://localhost:8815');

# Workers should still be available after driver registration.
query I
SELECT main.duckherder_get_worker_count();
----
2
