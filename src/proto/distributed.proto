syntax = "proto3";

package duckdb.distributed;

// Request types for distributed operations.
enum RequestType {
  REQUEST_TYPE_UNSPECIFIED = 0;
  EXECUTE_SQL = 1;
  CREATE_TABLE = 2;
  DROP_TABLE = 3;
  INSERT_DATA = 4;
  SCAN_TABLE = 5;
  DELETE_DATA = 6;
  TABLE_EXISTS = 7;
  CREATE_INDEX = 8;
  DROP_INDEX = 9;
  ALTER_TABLE = 10;
  LOAD_EXTENSION = 11;
  EXECUTE_PARTITION = 12;
  WORKER_REGISTER = 13;
  WORKER_HEARTBEAT = 14;
  GET_QUERY_EXECUTION_STATS = 15;
  READINESS_CHECK = 16;
}

// Execute SQL request.
message ExecuteSQLRequest {
  string sql = 1;
}

// Create table request.
// If the table already exists, return error.
message CreateTableRequest {
  // Table creation SQL statement.
  string sql = 1;
}

// Drop table request.
// If the table doesn't exist, nothing happens.
message DropTableRequest {
  string table_name = 1;
}

// Scan table request.
message ScanTableRequest {
  string table_name = 1;
  uint64 limit = 2;
  uint64 offset = 3;
}

// Delete data request.
message DeleteDataRequest {
  string table_name = 1;
  string where_clause = 2;
}

// Table exists request.
message TableExistsRequest {
  string table_name = 1;
}

// Create index request.
// If the index already exists, return error.
message CreateIndexRequest {
  // Index creation SQL statement.
  string sql = 1;
}

// Drop index request.
// If the index doesn't exist, nothing happens.
message DropIndexRequest {
  string index_name = 1;
}

// Alter table request.
message AlterTableRequest {
  // ALTER TABLE SQL statement.
  string sql = 1;
}

// Load extension request.
message LoadExtensionRequest {
  // Extension name or path.
  string extension_name = 1;
  // Optional repository.
  string repository = 2;
  // Optional version.
  string version = 3;
}

// Execute partition request, used for worker nodes.
message ExecutePartitionRequest {
  // SQL query to execute on partition.
  string sql = 1;
  // Serialized partition data (Arrow IPC format).
  bytes partition_data = 2;
  // Partition ID for tracking.
  uint64 partition_id = 3;
  // Total number of partitions.
  uint64 total_partitions = 4;
  // Serialized logical plan fragment (BinarySerializer format).
  bytes serialized_plan = 5;
  // Column names for the result.
  repeated string column_names = 6;
  // Serialized LogicalType definitions for the result columns.
  repeated bytes column_types = 7;
}

// Worker registration request.
message WorkerRegisterRequest {
  // Worker unique identifier
  string worker_id = 1;
  // Worker host address
  string host = 2;
  // Worker port
  uint32 port = 3;
  // Number of threads available
  uint32 num_threads = 4;
}

// Worker heartbeat request.
message WorkerHeartbeatRequest {
  string worker_id = 1;
  // Current load (0.0 to 1.0)
  double load = 2;
}

// Get query execution stats request.
message GetQueryExecutionStatsRequest {
  // Empty - returns all stats
}

// Readiness check request.
message ReadinessCheckRequest {
  // Empty - just checks if server is ready
}

// Request message for distributed operations.
message DistributedRequest {
  // Request-specific parameters.
  oneof request {
    ExecuteSQLRequest execute_sql = 1;
    CreateTableRequest create_table = 2;
    DropTableRequest drop_table = 3;
    ScanTableRequest scan_table = 4;
    DeleteDataRequest delete_data = 5;
    TableExistsRequest table_exists = 6;
    CreateIndexRequest create_index = 7;
    DropIndexRequest drop_index = 8;
    AlterTableRequest alter_table = 9;
    LoadExtensionRequest load_extension = 10;
    ExecutePartitionRequest execute_partition = 11;
    WorkerRegisterRequest worker_register = 12;
    WorkerHeartbeatRequest worker_heartbeat = 13;
    GetQueryExecutionStatsRequest get_query_execution_stats = 14;
    ReadinessCheckRequest readiness_check = 15;
  }
}

// Execute SQL response.
message ExecuteSQLResponse {
  uint64 rows_affected = 1;
}

// Create table response.
message CreateTableResponse {}

// Drop table response.
message DropTableResponse {}

// Scan table response, data returned via Arrow Flight.
message ScanTableResponse {
  uint64 row_count = 1;
}

// Delete data response.
message DeleteDataResponse {
  uint64 rows_deleted = 1;
}

// Table exists response.
message TableExistsResponse {
  bool exists = 1;
}

// Create index response.
message CreateIndexResponse {}

// Drop index response.
message DropIndexResponse {}

// Alter table response.
message AlterTableResponse {}

// Load extension response.
message LoadExtensionResponse {}

// Execute partition response (returns results via Arrow Flight).
message ExecutePartitionResponse {
  uint64 partition_id = 1;
  uint64 row_count = 2;
}

// Worker registration response.
message WorkerRegisterResponse {
  bool accepted = 1;
  string message = 2;
}

// Worker heartbeat response.
message WorkerHeartbeatResponse {
  bool healthy = 1;
}

// Individual query execution information.
message QueryExecutionInfo {
  string sql = 1;
  string execution_mode = 2;
  string merge_strategy = 3;
  int64 query_duration_ms = 4;
  uint64 num_workers_used = 5;
  uint64 num_tasks_generated = 6;
  int64 execution_start_time_ms = 7;
}

// Get query execution stats response.
message GetQueryExecutionStatsResponse {
  repeated QueryExecutionInfo query_executions = 1;
}

// Readiness check response.
message ReadinessCheckResponse {
  bool ready = 1;
}

// Response message for distributed operations.
message DistributedResponse {
  // Whether option succeeds.
  // TODO(hjiang): We don't need to craft error message inside of the response, instead we could use grpc response directly.
  bool success = 1;
  string error_message = 2;

  // Response-specific data.
  oneof response {
    ExecuteSQLResponse execute_sql = 3;
    CreateTableResponse create_table = 4;
    DropTableResponse drop_table = 5;
    ScanTableResponse scan_table = 6;
    DeleteDataResponse delete_data = 7;
    TableExistsResponse table_exists = 8;
    CreateIndexResponse create_index = 9;
    DropIndexResponse drop_index = 10;
    AlterTableResponse alter_table = 11;
    LoadExtensionResponse load_extension = 12;
    ExecutePartitionResponse execute_partition = 13;
    WorkerRegisterResponse worker_register = 14;
    WorkerHeartbeatResponse worker_heartbeat = 15;
    GetQueryExecutionStatsResponse get_query_execution_stats = 16;
    ReadinessCheckResponse readiness_check = 17;
  }
}
