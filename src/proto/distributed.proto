syntax = "proto3";

package duckdb.distributed;

// Request types for distributed operations.
enum RequestType {
  REQUEST_TYPE_UNSPECIFIED = 0;
  EXECUTE_SQL = 1;
  CREATE_TABLE = 2;
  DROP_TABLE = 3;
  INSERT_DATA = 4;
  SCAN_TABLE = 5;
  DELETE_DATA = 6;
  TABLE_EXISTS = 7;
  CREATE_INDEX = 8;
  DROP_INDEX = 9;
  ALTER_TABLE = 10;
}

// Execute SQL request.
message ExecuteSQLRequest {
  string sql = 1;
}

// Create table request.
// If the table already exists, return error.
message CreateTableRequest {
  // Table creation SQL statement.
  string sql = 1;
}

// Drop table request.
// If the table doesn't exist, nothing happens.
message DropTableRequest {
  string table_name = 1;
}

// Scan table request.
message ScanTableRequest {
  string table_name = 1;
  uint64 limit = 2;
  uint64 offset = 3;
}

// Delete data request.
message DeleteDataRequest {
  string table_name = 1;
  string where_clause = 2;
}

// Table exists request.
message TableExistsRequest {
  string table_name = 1;
}

// Create index request.
// If the index already exists, return error.
message CreateIndexRequest {
  // Index creation SQL statement.
  string sql = 1;
}

// Drop index request.
// If the index doesn't exist, nothing happens.
message DropIndexRequest {
  string index_name = 1;
}

// Alter table request.
message AlterTableRequest {
  // ALTER TABLE SQL statement.
  string sql = 1;
}

// Get catalog info request.
message GetCatalogInfoRequest {
  // Empty for now - gets all tables, columns, and indexes
}

// Column information.
message ColumnInfo {
  string name = 1;
  string type = 2;
  bool nullable = 3;
}

// Table information.
message TableInfo {
  string schema_name = 1;
  string table_name = 2;
  repeated ColumnInfo columns = 3;
}

// Index information.
message IndexInfo {
  string schema_name = 1;
  string table_name = 2;
  string index_name = 3;
  repeated string column_names = 4;
  bool is_unique = 5;
}

// Request message for distributed operations.
message DistributedRequest {
  // Optional database path for the server to use.
  // If empty, the server will use its default database.
  string db_path = 10;

  // Request-specific parameters.
  oneof request {
    ExecuteSQLRequest execute_sql = 1;
    CreateTableRequest create_table = 2;
    DropTableRequest drop_table = 3;
    ScanTableRequest scan_table = 4;
    DeleteDataRequest delete_data = 5;
    TableExistsRequest table_exists = 6;
    CreateIndexRequest create_index = 7;
    DropIndexRequest drop_index = 8;
    AlterTableRequest alter_table = 9;
    GetCatalogInfoRequest get_catalog_info = 11;
  }
}

// Execute SQL response.
message ExecuteSQLResponse {
  uint64 rows_affected = 1;
}

// Create table response.
message CreateTableResponse {}

// Drop table response.
message DropTableResponse {}

// Scan table response, data returned via Arrow Flight.
message ScanTableResponse {
  uint64 row_count = 1;
}

// Delete data response.
message DeleteDataResponse {
  uint64 rows_deleted = 1;
}

// Table exists response.
message TableExistsResponse {
  bool exists = 1;
}

// Create index response.
message CreateIndexResponse {}

// Drop index response.
message DropIndexResponse {}

// Alter table response.
message AlterTableResponse {}

// Get catalog info response.
message GetCatalogInfoResponse {
  repeated TableInfo tables = 1;
  repeated IndexInfo indexes = 2;
}

// Response message for distributed operations.
message DistributedResponse {
  // Whether option succeeds.
  // TODO(hjiang): We don't need to craft error message inside of the response, instead we could use grpc response directly.
  bool success = 1;
  string error_message = 2;

  // Response-specific data.
  oneof response {
    ExecuteSQLResponse execute_sql = 3;
    CreateTableResponse create_table = 4;
    DropTableResponse drop_table = 5;
    ScanTableResponse scan_table = 6;
    DeleteDataResponse delete_data = 7;
    TableExistsResponse table_exists = 8;
    CreateIndexResponse create_index = 9;
    DropIndexResponse drop_index = 10;
    AlterTableResponse alter_table = 11;
    GetCatalogInfoResponse get_catalog_info = 12;
  }
}
