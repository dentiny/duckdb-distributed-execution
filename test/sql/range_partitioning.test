# name: test/sql/range_partitioning.test
# description: Test RANGE-BASED partitioning - evenly divides data across workers using rowid ranges
# group: [sql]

# Partitioning method: rowid BETWEEN range_start AND range_end (not aligned with row groups)
# Dataset: 200,000 rows distributed evenly (50,000 rows per worker with 4 workers)
# This is > 122,880 rows (1 row group) to trigger NATURAL_PARTITION mode

require duckherder

# Start distributed server with 4 workers
statement ok
SELECT duckherder_start_local_server(8825, 4);

statement ok
ATTACH DATABASE ':memory:' AS dh (TYPE duckherder, server_host 'localhost', server_port 8825);

statement ok
USE dh;

statement ok
PRAGMA duckherder_register_remote_table('large_table', 'large_table');

statement ok
DROP TABLE IF EXISTS large_table;

statement ok
CREATE TABLE large_table (
    id INTEGER,
    value INTEGER,
    category VARCHAR,
    amount DECIMAL(10,2)
);

# Insert 200,000 rows to trigger intelligent range-based partitioning
# This ensures:
# - Natural parallelism > 0
# - Intelligent partitioning: YES
# - Range-based partition predicates (rowid BETWEEN x AND y)
# - Table size > 122,880 rows to use NATURAL_PARTITION mode
statement ok
INSERT INTO large_table 
SELECT 
    i,
    i * 100,
    CASE (i % 5)
        WHEN 0 THEN 'electronics'
        WHEN 1 THEN 'clothing'
        WHEN 2 THEN 'food'
        WHEN 3 THEN 'books'
        ELSE 'furniture'
    END,
    (i * 1.5)::DECIMAL(10,2)
FROM range(200000) t(i);

# Test 1: Verify partition boundary rows.
# Expected partitioning with 4 workers and 200,000 rows:
#   Worker 0: rowid BETWEEN 0 AND 49999       (50,000 rows)
#   Worker 1: rowid BETWEEN 50000 AND 99999   (50,000 rows)
#   Worker 2: rowid BETWEEN 100000 AND 149999 (50,000 rows)
#   Worker 3: rowid BETWEEN 150000 AND 199999 (50,000 rows)

# Test rows from Worker 0 boundary
query IIII
SELECT id, value, category, amount FROM large_table WHERE id = 0;
----
0	0	electronics	0.00

# Test rows from Worker 1 boundary
query IIII
SELECT id, value, category, amount FROM large_table WHERE id = 50000;
----
50000	5000000	electronics	75000.00

# Test rows from Worker 2 boundary
query IIII
SELECT id, value, category, amount FROM large_table WHERE id = 100000;
----
100000	10000000	electronics	150000.00

# Test rows from Worker 3 boundary
query IIII
SELECT id, value, category, amount FROM large_table WHERE id = 150000;
----
150000	15000000	electronics	225000.00

# Test last row
query IIII
SELECT id, value, category, amount FROM large_table WHERE id = 199999;
----
199999	19999900	furniture	299998.50

# Test 2: Verify rows from first partition (Worker 0: 0-49999)
query III
SELECT id, value, category FROM large_table WHERE id = 100;
----
100	10000	electronics

# Test 3: Verify rows from second partition (Worker 1: 50000-99999)
query III
SELECT id, value, category FROM large_table WHERE id = 75000;
----
75000	7500000	electronics

# Test 4: Verify rows from third partition (Worker 2: 100000-149999)
query III
SELECT id, value, category FROM large_table WHERE id = 125000;
----
125000	12500000	electronics

# Test 5: Verify rows from fourth partition (Worker 3: 150000-199999)
query III
SELECT id, value, category FROM large_table WHERE id = 175000;
----
175000	17500000	electronics

# Test 6: Filtered query across multiple partitions
query III
SELECT id, value, category FROM large_table WHERE category = 'food' AND id = 50002;
----
50002	5000200	food

query III
SELECT id, value, category FROM large_table WHERE category = 'food' AND id = 100007;
----
100007	10000700	food

# Test 7: Verify specific rows spanning partition boundaries
query III
SELECT id, value, category FROM large_table WHERE id = 49998;
----
49998	4999800	books

query III
SELECT id, value, category FROM large_table WHERE id = 50002;
----
50002	5000200	food

# Test 8: Query with predicate on non-key column
query III
SELECT id, value, category FROM large_table WHERE value = 5000000;
----
50000	5000000	electronics

# Test 9: Category-based filtering across all partitions
query II
SELECT id, category FROM large_table WHERE category = 'books' AND id = 150003;
----
150003	books

query II
SELECT id, category FROM large_table WHERE category = 'books' AND id = 150013;
----
150013	books

# Test 10: Verify end boundaries
query III
SELECT id, value, category FROM large_table WHERE id = 199995;
----
199995	19999500	electronics

query III
SELECT id, value, category FROM large_table WHERE id = 199999;
----
199999	19999900	furniture

# Verify execution mode.
query I
SELECT EXISTS(SELECT 1 FROM duckherder_get_query_execution_stats() 
              WHERE sql LIKE '%FROM large_table%' AND execution_mode = 'NATURAL_PARTITION');
----
true
