# name: test/sql/index_operations.test
# description: Test index creation and drop cases
# group: [sql]

require duckherder

statement ok
SELECT duckherder_start_local_server(8815);

statement ok
ATTACH DATABASE 'dh' (TYPE duckherder);

statement ok
PRAGMA duckherder_register_remote_table('idx_test', 'http://localhost:8815', 'idx_test');

# DROP INDEX on non-existent index should succeed (idempotent).
statement ok
DROP INDEX IF EXISTS dh.idx_test_id;

# Create a table successfully.
statement ok
CREATE TABLE dh.idx_test (id INTEGER, name VARCHAR);

# Insert some test data.
statement ok
INSERT INTO dh.idx_test VALUES (1, 'Alice'), (2, 'Bob'), (3, 'Charlie');

# Create an index successfully.
statement ok
CREATE INDEX idx_test_id ON dh.idx_test(id);

# Attempt to create the same index again should fail.
statement error
CREATE INDEX idx_test_id ON dh.idx_test(id);
----

# Create another index successfully.
# Note: The table name dh.idx_test appears once in the CREATE INDEX statement,
# testing that RemoveCatalogPrefix correctly strips the catalog prefix.
statement ok
CREATE INDEX idx_test_name ON dh.idx_test(name);

# Verify data is still accessible after index creation.
query II
SELECT * FROM dh.idx_test ORDER BY id;
----
1	Alice
2	Bob
3	Charlie

# Verify both indexes are listed in duckdb_indexes().
query IIII
SELECT database_name, schema_name, index_name, table_name 
FROM duckdb_indexes() 
WHERE database_name = 'dh' AND table_name = 'idx_test'
ORDER BY index_name;
----
dh	main	idx_test_id	idx_test
dh	main	idx_test_name	idx_test

# DROP INDEX should succeed.
statement ok
DROP INDEX dh.idx_test_id;

# DROP INDEX on already dropped index with IF EXISTS should succeed.
statement ok
DROP INDEX IF EXISTS dh.idx_test_id;

# DROP INDEX on already dropped index without IF EXISTS should fail.
statement error
DROP INDEX dh.idx_test_id;
----

# Verify data is still accessible after index drop.
query II
SELECT * FROM dh.idx_test ORDER BY id;
----
1	Alice
2	Bob
3	Charlie

# Verify only the remaining index is listed after dropping idx_test_id.
query IIII
SELECT database_name, schema_name, index_name, table_name 
FROM duckdb_indexes() 
WHERE database_name = 'dh' AND table_name = 'idx_test'
ORDER BY index_name;
----
dh	main	idx_test_name	idx_test

# Drop the remaining index.
statement ok
DROP INDEX dh.idx_test_name;

# Verify no indexes remain after dropping all indexes.
query IIII
SELECT database_name, schema_name, index_name, table_name 
FROM duckdb_indexes() 
WHERE database_name = 'dh' AND table_name = 'idx_test'
ORDER BY index_name;
----

# Clean up the table.
statement ok
DROP TABLE dh.idx_test;
