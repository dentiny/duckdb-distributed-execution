# name: test/sql/no_worker_execution.test
# description: Test local execution fallback when no workers are registered
# group: [sql]

require duckherder

# Start distributed server with no workers.
statement ok
SELECT duckherder_start_local_server(8815);

statement ok
ATTACH DATABASE ':memory:' AS dh (TYPE duckherder, server_host 'localhost', server_port 8815);

statement ok
USE dh;

statement ok
PRAGMA duckherder_register_remote_table('no_worker_table', 'no_worker_table');

statement ok
CREATE TABLE no_worker_table (id INTEGER, value VARCHAR, amount INTEGER);

statement ok
INSERT INTO no_worker_table VALUES
    (1, 'apple', 100),
    (2, 'banana', 200),
    (3, 'cherry', 300),
    (4, 'date', 400),
    (5, 'elderberry', 500);

query III
SELECT id, value, amount FROM no_worker_table ORDER BY id;
----
1	apple	100
2	banana	200
3	cherry	300
4	date	400
5	elderberry	500

query II
SELECT COUNT(*) as total, SUM(amount) as total_amount FROM no_worker_table;
----
5	1500

query I
SELECT EXISTS(SELECT 1 FROM duckherder_get_query_execution_stats() 
              WHERE sql LIKE '%FROM no_worker_table%' AND execution_mode = 'LOCAL');
----
true
