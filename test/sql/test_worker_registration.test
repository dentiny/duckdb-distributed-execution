# name: test/sql/test_worker_registration.test
# description: Test worker registration functions for distributed execution
# group: [sql]

require duckherder

# Start distributed server with local workers
statement ok
SELECT duckherder_start_local_server(8815, 2);

# Test 1: Verify initial worker count (2 workers from server start)
# Note: Must check before attaching remote database
query I
SELECT duckherder_get_worker_count();
----
2

# Test 2: Start additional local workers
statement ok
SELECT duckherder_start_local_workers(1);

# Test 3: Verify worker count increased
query I
SELECT duckherder_get_worker_count();
----
3

statement ok
ATTACH DATABASE 'dh' (TYPE duckherder, server_host 'localhost', server_port 8815);

statement ok
USE dh;

# Test 4: Register multiple workers at once (API test)
# Should return 0 since no workers are running at those addresses
# Must call from main database context
query I
SELECT main.duckherder_register_workers(
    ['worker_ext_1', 'worker_ext_2'],
    ['grpc://localhost:29101', 'grpc://localhost:29102']
);
----
0

# Test 5: Worker count should remain unchanged (3 local workers only)
# Must call from main database context
query I
SELECT main.duckherder_get_worker_count();
----
3

# Test 6: Create a table and verify distributed execution works
statement ok
PRAGMA duckherder_register_remote_table('worker_reg_test', 'worker_reg_test');

statement ok
CREATE TABLE worker_reg_test (id INTEGER, name VARCHAR);

statement ok
INSERT INTO worker_reg_test VALUES (1, 'test1'), (2, 'test2'), (3, 'test3');

query II
SELECT * FROM worker_reg_test ORDER BY id;
----
1	test1
2	test2
3	test3

