# name: test/sql/parallel_aggregation.test
# description: Test parallel execution infrastructure (verify intelligent partitioning logic)
# group: [sql]

require duckherder

# Start distributed server with 4 workers to leverage parallelism
statement ok
SELECT duckherder_start_local_server(8815, 4);

statement ok
ATTACH DATABASE ':memory:' AS dh (TYPE duckherder, server_host 'localhost', server_port 8815);

statement ok
USE dh;

statement ok
PRAGMA duckherder_register_remote_table('parallel_test', 'parallel_test');

statement ok
DROP TABLE IF EXISTS parallel_test;

statement ok
CREATE TABLE parallel_test (id INTEGER, category VARCHAR, value INTEGER);

# Insert a small dataset for testing
statement ok
INSERT INTO parallel_test VALUES
    (1, 'electronics', 100),
    (2, 'clothing', 200),
    (3, 'food', 300),
    (4, 'books', 400),
    (5, 'electronics', 500);

# Test 1: Basic select
query III
SELECT id, category, value FROM parallel_test WHERE id = 1;
----
1	electronics	100

# Test 2: Filtered select
query III
SELECT id, category, value FROM parallel_test WHERE category = 'food';
----
3	food	300

# Test 3: Multiple rows
query III
SELECT id, category, value FROM parallel_test WHERE category = 'electronics';
----
1	electronics	100
5	electronics	500

# Test 4: Verify query stats infrastructure is working
query I
SELECT COUNT(*) > 0 FROM duckherder_get_query_execution_stats();
----
true

