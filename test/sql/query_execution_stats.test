# name: test/sql/query_execution_stats.test
# description: Test query execution stats table function
# group: [sql]

require duckherder

# Start distributed server
statement ok
SELECT duckherder_start_local_server(8862, 2);

statement ok
ATTACH DATABASE ':memory:' AS dh (TYPE duckherder, server_host 'localhost', server_port 8862);

statement ok
USE dh;

statement ok
PRAGMA duckherder_register_remote_table('stats_test', 'stats_test');

statement ok
CREATE TABLE stats_test (id INTEGER, name VARCHAR);

statement ok
INSERT INTO stats_test VALUES (1, 'Alice'), (2, 'Bob'), (3, 'Charlie');

# Execute a simple query
query II
SELECT * FROM stats_test ORDER BY id;
----
1	Alice
2	Bob
3	Charlie

# Execute an aggregation
query I
SELECT COUNT(*) FROM stats_test;
----
3

# Now test the query execution stats
# After running some queries above, we should have stats recorded
# Test 1: Table function exists and has recorded our queries
query I
SELECT COUNT(*) > 0 FROM duckherder_get_query_execution_stats();
----
true

# Test 2: Verify schema - all columns are accessible and we have SQL recorded
query I
SELECT COUNT(*) > 0 FROM (
    SELECT sql, execution_mode, merge_strategy, query_duration_ms, 
           worker_execution_time_ms, num_workers_used, num_tasks_generated, 
           execution_start_time 
    FROM duckherder_get_query_execution_stats()
) WHERE sql IS NOT NULL;
----
true

# Test 3: Verify execution modes are valid (only distributed modes)
query I
SELECT COUNT(*) 
FROM duckherder_get_query_execution_stats()
WHERE execution_mode NOT IN ('DELEGATED', 'NATURAL_PARTITION', 'ROW_GROUP_PARTITION');
----
0

# Test 4: Verify merge strategies are valid
query I
SELECT COUNT(*)
FROM duckherder_get_query_execution_stats()
WHERE merge_strategy NOT IN ('NONE', 'CONCATENATE', 'AGGREGATE', 'GROUP_BY', 'DISTINCT');
----
0

# Test 5: Verify timing fields are non-negative
query I
SELECT COUNT(*)
FROM duckherder_get_query_execution_stats()
WHERE query_duration_ms < 0 OR worker_execution_time_ms < 0;
----
0

# Test 6: Verify worker and task counts are non-negative
query I
SELECT COUNT(*)
FROM duckherder_get_query_execution_stats()
WHERE num_workers_used < 0 OR num_tasks_generated < 0;
----
0

# Test 7: Verify execution_start_time is populated
query I
SELECT COUNT(*)
FROM duckherder_get_query_execution_stats()
WHERE execution_start_time IS NULL;
----
0

# Test 8: If there are any stats, check they're reasonable (only distributed execution modes)
query I
SELECT CASE 
    WHEN COUNT(*) = 0 THEN true
    ELSE (SELECT COUNT(*) > 0 
          FROM duckherder_get_query_execution_stats() 
          WHERE sql IS NOT NULL 
            AND LENGTH(sql) > 0
            AND execution_mode IN ('DELEGATED', 'NATURAL_PARTITION', 'ROW_GROUP_PARTITION'))
END
FROM duckherder_get_query_execution_stats();
----
true

