# name: test/sql/test_worker_registration.test
# description: Test worker registration functions for distributed execution
# group: [sql]

require duckherder

# Test 1: Start standalone workers (not registered yet)
statement ok
SELECT duckherder_start_standalone_worker(29101);

statement ok
SELECT duckherder_start_standalone_worker(29102);

# Test 2: Start distributed server WITHOUT workers
statement ok
SELECT duckherder_start_local_server(8815);

# Test 3: Verify no workers initially
query I
SELECT duckherder_get_worker_count();
----
0

# Test 4: Register the standalone workers
statement ok
SELECT duckherder_register_worker('worker_ext_1', 'grpc://localhost:29101');

statement ok
SELECT duckherder_register_worker('worker_ext_2', 'grpc://localhost:29102');

# Test 5: Verify workers are now registered
query I
SELECT duckherder_get_worker_count();
----
2

# Test 6: Start additional local workers  
statement ok
SELECT duckherder_start_local_workers(1);

# Test 7: Verify worker count increased
query I
SELECT duckherder_get_worker_count();
----
3

statement ok
ATTACH DATABASE 'dh' (TYPE duckherder, server_host 'localhost', server_port 8815);

statement ok
USE dh;

# Test 8: Try to register non-existent external workers (should fail gracefully)
# Should return 0 since no workers are running at those addresses
# Must call from main database context
query I
SELECT main.duckherder_register_workers(
    ['worker_bad_1', 'worker_bad_2'],
    ['grpc://localhost:30001', 'grpc://localhost:30002']
);
----
0

# Test 9: Worker count should remain unchanged (3 registered workers)
# Must call from main database context
query I
SELECT main.duckherder_get_worker_count();
----
3

# Test 9: Create a table and verify distributed execution works
statement ok
PRAGMA duckherder_register_remote_table('worker_reg_test', 'worker_reg_test');

statement ok
CREATE TABLE worker_reg_test (id INTEGER, name VARCHAR);

statement ok
INSERT INTO worker_reg_test VALUES (1, 'test1'), (2, 'test2'), (3, 'test3');

query II
SELECT * FROM worker_reg_test ORDER BY id;
----
1	test1
2	test2
3	test3

