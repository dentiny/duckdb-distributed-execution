# name: test/sql/alter_table.test
# description: Test ALTER TABLE operations on remote tables
# group: [sql]

require motherduck

statement ok
SELECT start_distributed_server(8815);

statement ok
ATTACH DATABASE 'md' (TYPE motherduck);

statement ok
PRAGMA md_register_remote_table('test_alter_table', 'http://localhost:8815', 'test_alter_table');

statement ok
DROP TABLE IF EXISTS md.test_alter_table;

statement ok
CREATE TABLE md.test_alter_table (id INTEGER, name VARCHAR);

statement ok
INSERT INTO md.test_alter_table VALUES (1, 'Alice'), (2, 'Bob');

query II
SELECT * FROM md.test_alter_table ORDER BY id;
----
1	Alice
2	Bob

# 
statement ok
ALTER TABLE md.test_alter_table ADD COLUMN age INTEGER;

# Verify the schema was updated  
query III
SELECT * FROM md.test_alter_table ORDER BY id;
----
1	Alice	NULL
2	Bob	NULL

# Insert data with the new column
statement ok
INSERT INTO md.test_alter_table VALUES (3, 'Charlie', 30);

# Verify data after adding column
query III
SELECT * FROM md.test_alter_table ORDER BY id;
----
1	Alice	NULL
2	Bob	NULL
3	Charlie	30

# Rename a column
statement ok
ALTER TABLE md.test_alter_table RENAME COLUMN name TO full_name;

# Verify renamed column
query III
SELECT id, full_name, age FROM md.test_alter_table ORDER BY id;
----
1	Alice	NULL
2	Bob	NULL
3	Charlie	30

# Drop a column
statement ok
ALTER TABLE md.test_alter_table DROP COLUMN age;

# Verify column dropped
query II
SELECT * FROM md.test_alter_table ORDER BY id;
----
1	Alice
2	Bob
3	Charlie

# Add column with DEFAULT value
statement ok
ALTER TABLE md.test_alter_table ADD COLUMN status VARCHAR DEFAULT 'active';

# Verify default value is applied
query III
SELECT * FROM md.test_alter_table ORDER BY id;
----
1	Alice	active
2	Bob	active
3	Charlie	active

# Insert with explicit columns including status
statement ok
INSERT INTO md.test_alter_table (id, full_name, status) VALUES (4, 'David', 'pending');

# Verify the insert
query III
SELECT * FROM md.test_alter_table WHERE id = 4;
----
4	David	pending

# Add column without default
statement ok
ALTER TABLE md.test_alter_table ADD COLUMN score INTEGER;

# Verify NULL for existing rows
query IIII
SELECT * FROM md.test_alter_table ORDER BY id;
----
1	Alice	active	NULL
2	Bob	active	NULL
3	Charlie	active	NULL
4	David	pending	NULL

# Insert with all columns
statement ok
INSERT INTO md.test_alter_table VALUES (5, 'Eve', 'inactive', 95);

# Verify full row
query IIII
SELECT * FROM md.test_alter_table WHERE id = 5;
----
5	Eve	inactive	95

# Drop column with IF EXISTS
statement ok
ALTER TABLE md.test_alter_table DROP COLUMN IF EXISTS score;

# Verify column dropped
query III
SELECT * FROM md.test_alter_table ORDER BY id LIMIT 2;
----
1	Alice	active
2	Bob	active

# Try to drop non-existent column with IF EXISTS (should succeed silently)
statement ok
ALTER TABLE md.test_alter_table DROP COLUMN IF EXISTS nonexistent_col;

# Add column with IF NOT EXISTS
statement ok
ALTER TABLE md.test_alter_table ADD COLUMN IF NOT EXISTS email VARCHAR;

# Try to add same column again with IF NOT EXISTS (should succeed silently)
statement ok
ALTER TABLE md.test_alter_table ADD COLUMN IF NOT EXISTS email VARCHAR;

# Verify only one email column exists
query IIII
SELECT * FROM md.test_alter_table WHERE id = 1;
----
1	Alice	active	NULL

# Test ALTER on non-existent table, which should fail.
statement error
ALTER TABLE md.nonexistent_table DROP COLUMN some_column;
----
Catalog Error: Table with name nonexistent_table does not exist

# Test ALTER with IF EXISTS on non-existent table, which should fail.
statement error
ALTER TABLE md.nonexistent_table DROP COLUMN IF EXISTS some_column;
----
Catalog Error: Table with name nonexistent_table does not exist

# Clean up
statement ok
PRAGMA md_unregister_remote_table('test_alter_table');

statement ok
DROP TABLE md.test_alter_table;
