# name: test/sql/local_execution.test
# description: Test local execution mode for queries that cannot be distributed
# group: [sql]

require duckherder

# Start distributed server with 2 workers
statement ok
SELECT duckherder_start_local_server(8840, 2);

statement ok
ATTACH DATABASE ':memory:' AS dh (TYPE duckherder, server_host 'localhost', server_port 8840);

statement ok
USE dh;

statement ok
PRAGMA duckherder_register_remote_table('local_test', 'local_test');

statement ok
CREATE TABLE local_test (id INTEGER, value VARCHAR, amount INTEGER);

statement ok
INSERT INTO local_test VALUES
    (1, 'apple', 100),
    (2, 'banana', 200),
    (3, 'cherry', 300),
    (4, 'date', 400),
    (5, 'elderberry', 500);

# Query with ORDER BY - cannot be distributed, should execute locally on the driver node.
query III
SELECT id, value, amount FROM local_test ORDER BY id;
----
1	apple	100
2	banana	200
3	cherry	300
4	date	400
5	elderberry	500

# Query with ORDER BY DESC, which also executes on driver node locally.
query III
SELECT id, value, amount FROM local_test ORDER BY amount DESC;
----
5	elderberry	500
4	date	400
3	cherry	300
2	banana	200
1	apple	100
