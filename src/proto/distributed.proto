syntax = "proto3";

package duckdb.distributed;

// Execute SQL request.
message ExecuteSQLRequest {
  string sql = 1;
}

// Create table request.
// If the table already exists, return error.
message CreateTableRequest {
  // Table creation SQL statement.
  string sql = 1;
}

// Drop table request.
// If the table doesn't exist, nothing happens.
message DropTableRequest {
  string table_name = 1;
}

// Scan table request.
message ScanTableRequest {
  string table_name = 1;
  uint64 limit = 2;
  uint64 offset = 3;
}

// Delete data request.
message DeleteDataRequest {
  string table_name = 1;
  string where_clause = 2;
}

// Table exists request.
message TableExistsRequest {
  string table_name = 1;
}

// Create index request.
// If the index already exists, return error.
message CreateIndexRequest {
  // Index creation SQL statement.
  string sql = 1;
}

// Drop index request.
// If the index doesn't exist, nothing happens.
message DropIndexRequest {
  string index_name = 1;
}

// Alter table request.
message AlterTableRequest {
  // ALTER TABLE SQL statement.
  string sql = 1;
}

// Get catalog info request.
message GetCatalogInfoRequest {
  // Empty for now - gets all tables, columns, and indexes
}

// Column information.
message ColumnInfo {
  string name = 1;
  string type = 2;
  bool nullable = 3;
}

// Table information.
message TableInfo {
  string schema_name = 1;
  string table_name = 2;
  repeated ColumnInfo columns = 3;
}

// Index information.
message IndexInfo {
  string schema_name = 1;
  string table_name = 2;
  string index_name = 3;
  repeated string column_names = 4;
  bool is_unique = 5;
}

// Request message for distributed operations.
message DistributedRequest {
  // Database path for the server to use.
  // - If non-empty: specifies the file path to a DuckDB database file
  // - If empty: the server will use an in-memory database
  // Each request must specify which database it operates on for stateless operation, which is used to indicate the duckdb instance to operate on.
  string db_path = 1;

  // Request-specific parameters.
  oneof request {
    // DDL operations.
    CreateTableRequest create_table = 2;
    DropTableRequest drop_table = 3;
    CreateIndexRequest create_index = 4;
    DropIndexRequest drop_index = 5;
    AlterTableRequest alter_table = 6;

    // DML operations
    ExecuteSQLRequest execute_sql = 7;
    ScanTableRequest scan_table = 8;
    DeleteDataRequest delete_data = 9;

    // Util operations
    TableExistsRequest table_exists = 10;
    GetCatalogInfoRequest get_catalog_info = 11;
  }
}

// Execute SQL response.
message ExecuteSQLResponse {
  uint64 rows_affected = 1;
}

// Create table response.
message CreateTableResponse {}

// Drop table response.
message DropTableResponse {}

// Scan table response, data returned via Arrow Flight.
message ScanTableResponse {
  uint64 row_count = 1;
}

// Delete data response.
message DeleteDataResponse {
  uint64 rows_deleted = 1;
}

// Table exists response.
message TableExistsResponse {
  bool exists = 1;
}

// Create index response.
message CreateIndexResponse {}

// Drop index response.
message DropIndexResponse {}

// Alter table response.
message AlterTableResponse {}

// Get catalog info response.
message GetCatalogInfoResponse {
  repeated TableInfo tables = 1;
  repeated IndexInfo indexes = 2;
}

// Response message for distributed operations.
message DistributedResponse {
  // Whether operation succeeds.
  // TODO(hjiang): We don't need to craft error message inside of the response,
  // instead we could use grpc response directly.
  bool success = 1;
  string error_message = 2;

  // Response-specific data.
  oneof response {
    // DDL responses.
    CreateTableResponse create_table = 3;
    DropTableResponse drop_table = 4;
    CreateIndexResponse create_index = 5;
    DropIndexResponse drop_index = 6;
    AlterTableResponse alter_table = 7;

    // DML responses.
    ExecuteSQLResponse execute_sql = 8;
    ScanTableResponse scan_table = 9;
    DeleteDataResponse delete_data = 10;

    // Util responses.
    TableExistsResponse table_exists = 11;
    GetCatalogInfoResponse get_catalog_info = 12;
  }
}
