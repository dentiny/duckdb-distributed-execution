# name: test/sql/test_worker_registration.test
# description: Test worker registration functions for distributed execution
# group: [sql]

require duckherder

# Start standalone workers.
statement ok
SELECT duckherder_start_standalone_worker(29101);

statement ok
SELECT duckherder_start_standalone_worker(29102);

# Start distributed server without workers.
statement ok
SELECT duckherder_start_local_server(8815);

query I
SELECT duckherder_get_worker_count();
----
0

# Register the standalone workers.
statement ok
SELECT duckherder_register_worker('worker_ext_1', 'grpc://localhost:29101');

statement ok
SELECT duckherder_register_worker('worker_ext_2', 'grpc://localhost:29102');

query I
SELECT duckherder_get_worker_count();
----
2

# Start additional local workers and register.  
statement ok
SELECT duckherder_start_local_workers(1);

query I
SELECT duckherder_get_worker_count();
----
3

statement ok
ATTACH DATABASE 'dh' (TYPE duckherder, server_host 'localhost', server_port 8815);

statement ok
USE dh;

# Execute queries and validate.
query I
SELECT main.duckherder_get_worker_count();
----
3

statement ok
PRAGMA duckherder_register_remote_table('worker_reg_test', 'worker_reg_test');

statement ok
CREATE TABLE worker_reg_test (id INTEGER, name VARCHAR);

statement ok
INSERT INTO worker_reg_test VALUES (1, 'test1'), (2, 'test2'), (3, 'test3');

query II
SELECT * FROM worker_reg_test ORDER BY id;
----
1	test1
2	test2
3	test3
