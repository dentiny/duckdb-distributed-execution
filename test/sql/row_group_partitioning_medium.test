# name: test/sql/row_group_partitioning_medium.test
# description: Test ROW GROUP-BASED partitioning with medium dataset (250K rows for faster testing)
# group: [sql]

# Partitioning method: rowid BETWEEN rg_start AND rg_end (aligned with row group boundaries)
# Dataset: 250,000 rows creating ~2 row groups (2x faster than 500K test)
# Row group size: 122,880 rows/group, so 250K rows = 2 full groups + partial

require duckherder

# Start distributed server with 4 workers
statement ok
SELECT duckherder_start_local_server(8815, 4);

# Attach distributed database
statement ok
ATTACH DATABASE ':memory:' AS dh (TYPE duckherder, server_host 'localhost', server_port 8815);

statement ok
USE dh;

# Register the table for distributed access
statement ok
PRAGMA duckherder_register_remote_table('rg_medium_table', 'rg_medium_table');

# Create a table with 250,000 rows (creates ~2 row groups)
# Row group size = 122,880, so 250K / 122,880 â‰ˆ 2.03 row groups
# This is 2x faster than 500K rows while still testing row group partitioning
statement ok
CREATE TABLE rg_medium_table (
    id INTEGER,
    value INTEGER,
    category VARCHAR
);

# Insert 250,000 rows
statement ok
INSERT INTO rg_medium_table 
SELECT 
    i AS id,
    i * 100 AS value,
    CASE (i % 5)
        WHEN 0 THEN 'electronics'
        WHEN 1 THEN 'clothing'
        WHEN 2 THEN 'food'
        WHEN 3 THEN 'books'
        ELSE 'other'
    END AS category
FROM range(0, 250000) t(i);

# Test 1: Verify data integrity with aggregations
query III
SELECT 
    COUNT(*) as total_rows,
    MIN(id) as min_id,
    MAX(id) as max_id
FROM rg_medium_table;
----
250000	0	249999

# Test 2: Verify category distribution
query IT
SELECT category, COUNT(*) as cnt
FROM rg_medium_table
GROUP BY category
ORDER BY category;
----
books	50000
clothing	50000
electronics	50000
food	50000
other	50000

# Test 3: Query first row group boundary (0-122879)
query II
SELECT COUNT(*), SUM(value) 
FROM rg_medium_table 
WHERE id >= 0 AND id < 122880;
----
122880	754968576000

# Test 4: Query second row group boundary (122880-245759)
query II
SELECT COUNT(*), SUM(value) 
FROM rg_medium_table 
WHERE id >= 122880 AND id < 245760;
----
122880	2264918016000

# Test 5: Point queries in different row groups
# Row in first row group
query III
SELECT id, value, category 
FROM rg_medium_table 
WHERE id = 50000;
----
50000	5000000	electronics

# Row in second row group
query III
SELECT id, value, category 
FROM rg_medium_table 
WHERE id = 150000;
----
150000	15000000	electronics

# Test 6: Aggregation with GROUP BY spanning row groups
query IT
SELECT category, COUNT(*) as cnt
FROM rg_medium_table
WHERE id >= 100000 AND id < 200000
GROUP BY category
ORDER BY category;
----
books	20000
clothing	20000
electronics	20000
food	20000
other	20000

# Test 7: Verify SUM across all rows
query I
SELECT SUM(value) FROM rg_medium_table;
----
3124987500000

# Test 8: DISTINCT count
query I
SELECT COUNT(DISTINCT id) FROM rg_medium_table;
----
250000

# Test 9: Verify execution mode is ROW_GROUP_PARTITION
query I
SELECT EXISTS(SELECT 1 FROM duckherder_get_query_execution_stats() 
              WHERE sql LIKE '%FROM rg_medium_table%' AND execution_mode = 'NATURAL_PARTITION');
----
true
